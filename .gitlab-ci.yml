stages:
  - deploy

.deploy:
  stage: deploy
  retry:
    max: 1  # Add one retry, especially for acceptance-tests
    when: always
  tags:
    - aws
    - mozmeao
  script:
    - kubectl apply -f ${DEPLOYMENT}
    - kubectl rollout status -f ${DEPLOYMENT}/web-deploy.yaml
    - ./newrelic-notify.sh
    # Retry doesn't seem to work for now. Sleep a few seconds before running the
    # tests.
    - sleep 5s
    - ./acceptance-tests.sh ${URL}

deploy oregon-a dev:
  extends: .deploy
  variables:
    DEPLOYMENT: oregon-a/snippets-dev
    KUBECONFIG: /home/gitlab-runner/.kube/oregon-a.kubeconfig
    NEWRELIC_APP: snippets-dev-oregon-a
    URL: https://snippets-dev.oregon-b.moz.works
  only:
    changes:
      - "oregon-a/snippets-dev/*"
    refs:
      - master

deploy oregon-a stage:
  extends: .deploy
  variables:
    DEPLOYMENT: oregon-a/snippets-stage
    KUBECONFIG: /home/gitlab-runner/.kube/oregon-a.kubeconfig
    NEWRELIC_APP: snippets-stage-oregon-a
    URL: https://snippets.allizom.org
  only:
    changes:
      - "oregon-a/snippets-stage/*"
    refs:
      - master

deploy oregon-a prod:
  extends: .deploy
  variables:
    DEPLOYMENT: oregon-a/snippets-prod
    KUBECONFIG: /home/gitlab-runner/.kube/oregon-a.kubeconfig
    NEWRELIC_APP: snippets-prod-oregon-a
    URL: https://snippets-prod.oregon-b.moz.works
  only:
    changes:
      - "oregon-a/snippets-prod/*"
    refs:
      - master

deploy frankfurt prod:
  extends: .deploy
  variables:
    DEPLOYMENT: frankfurt/snippets-prod
    KUBECONFIG: /home/gitlab-runner/.kube/frankfurt.kubeconfig
    NEWRELIC_APP: snippets-prod-frankfurt
    URL: https://snippets-prod.frankfurt.moz.works
  only:
    changes:
      - "frankfurt/snippets-prod/*"
    refs:
      - master

deploy oregon-a admin:
  extends: .deploy
  variables:
    DEPLOYMENT: oregon-a/snippets-admin
    KUBECONFIG: /home/gitlab-runner/.kube/oregon-a.kubeconfig
    NEWRELIC_APP: snippets-admin-oregon-a
    URL: https://snippets-admin.mozilla.org
  only:
    changes:
      - "oregon-a/snippets-admin/*"
    refs:
      - master
