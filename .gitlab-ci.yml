stages:
  - deploy

.deploy:
  stage: deploy
  retry: 2  # Add two retries, especially for acceptance-tests
  script:
    - kubectl_1.11 apply -f ${DEPLOYMENT}
    - kubectl_1.11 rollout status -f ${DEPLOYMENT}/web-deploy.yaml
    - ./acceptance-tests.sh ${URL}


deploy oregon-b dev:
  extends: .deploy
  variables:
    KUBECONFIG: /home/gitlab-runner/.kube/oregon-b.kubeconfig
    DEPLOYMENT: oregon-b/snippets-dev
    URL: https://snippets-dev.oregon-b.moz.works
  only:
    changes:
      - "oregon-b/snippets-dev/*"

deploy oregon-b stage:
  extends: .deploy
  variables:
    KUBECONFIG: /home/gitlab-runner/.kube/oregon-b.kubeconfig
    DEPLOYMENT: oregon-b/snippets-stage
    URL: https://snippets.allizom.org
  only:
    changes:
      - "oregon-b/snippets-stage/*"

deploy oregon-b prod:
  extends: .deploy
  variables:
    KUBECONFIG: /home/gitlab-runner/.kube/oregon-b.kubeconfig
    DEPLOYMENT: oregon-b/snippets-prod
    URL: https://snippets-prod.oregon-b.moz.works
  only:
    changes:
      - "oregon-b/snippets-prod/*"

deploy frankfurt prod:
  extends: .deploy
  variables:
    KUBECONFIG: /home/gitlab-runner/.kube/frankfurt.kubeconfig
    DEPLOYMENT: frankfurt/snippets-prod
    URL: https://snippets-prod.frankfurt.moz.works
  only:
    changes:
      - "frankfurt/snippets-prod/*"

deploy oregon-b admin:
  extends: .deploy
  variables:
    KUBECONFIG: /home/gitlab-runner/.kube/oregon-b.kubeconfig
    DEPLOYMENT: oregon-b/snippets-admin
    URL: https://snippets-admin.mozilla.org
  only:
    changes:
      - "oregon-b/snippets-admin/*"
